---
import Cross from "../Icons/Cross.astro";
import Preloader from "../Icons/Preloader.astro";
import Status from "./Status.astro";

// const params = [
//   {
//     name: "charset",
//     value: "UTF-8",
//   },
//   {
//     name: "default_list_id",
//     value: "1",
//   },
//   {
//     name: "overwrite",
//     value: "2",
//   },
//   {
//     name: "is_v5",
//     value: "1",
//   },
// ];
---

<div class="container" style="display: flex; justify-content: center;">
  <form
    class="fap-form-subscribe"
    name="subscribtion_form"
    method="POST"
    id="form-subscribe"
    action="https://h.integrations-hub.ru/wh/38/1lfvk4c/irlsKYTYRHlIMjXaGAzBC5Qrr5yuKJqP2mZJXkqOKAo/"
  >
    <h2 class="fap-form-subscribe__title">Подпишитесь на основную рассылку</h2>
    <p>
      Будьте в курсе актуальных новостей компании, новых технологий и
      нестандартных решений для воплощения самых смелых идей в сфере
      коммерческой полиграфии.
    </p>
    <div class="fap-form-subscribe-field">
      <div class="fap-form-subscribe-field-wrap">
        <input
          class="fap-form-subscribe-field__input-email"
          name="email"
          type="email"
          placeholder="Email:"
          required
        />
        <button class="fap-form-subscribe-field__input-reset" type="reset">
          <Cross />
        </button>
      </div>

      <div class="fap-form-subscribe-field__line"></div>
      <button class="fap-form-subscribe-field__submit" type="submit">Подписаться</button>
    </div>
    <Status disabled={false} status="pending">Загрузка...</Status>
    <Status disabled={true} status="error"></Status>
    <Status disabled={false} status="success">Готово! Проверьте свою электронную почту для потверждения регистрации.</Status>
    <div class="fap-form-subscribe-confirm">
      <input type="checkbox" name="confirm" id="confirm" />
      <label for="confirm">Я согласен с политикой конфиденциальности</label>
      <p class="fap-form-subscribe-confirm__error-message">Это поле обязательно к заполнению.</p>
    </div>
  </form>
</div>

<style lang="scss" is:global>
  .fap-form-subscribe {
    background-color: var(--color-light-gray);
    max-width: 400px;
    padding: 1.42em;
    display: flex;
    flex-direction: column;
    gap: 1.42em;

    * {
      font-family: "Roboto", "Helvetica Neue", sans-serif;
      margin: 0;
    }

    @media (width < 768px) {
      font-size: 90%;
    }
  }
  .fap-form-subscribe__title {
    font-size: 1em;
    text-transform: uppercase;
  }

  .fap-form-subscribe-field {
    display: flex;
    background-color: var(--color-white);
    padding: 0.85em;
    transition: var(--animate-default);
    transition-property: border;
    border: 2px solid var(--color-light-gray);
    @media (width < 400px) {
      padding: 0;
      flex-direction: column;
    }
  }
  .fap-form-subscribe-field-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    @media (width < 400px) {
      padding: .5em;
    }
  }
  .fap-form-subscribe-field__input-reset {
    border: none;
    background-color: transparent;
    outline: none;
  }

  .fap-form-subscribe-field__line {
    width: 2px;
    height: 20px;
    margin: 0 5px;
    background-color: var(--color-black);
    @media (width < 400px) {
      display: none;
    }
  }
  .fap-form-subscribe-field__submit {
    background-color: transparent;
    font-weight: 500;
    color: var(--color-primary);
    border: none;
    cursor: pointer;
    @media (width < 400px) {
      background-color: var(--color-primary);
      color: var(--color-white);
      padding: .5em;
    }
  }
  .fap-form-subscribe-field__input-email {
    flex: 1;
    background-color: transparent;
    border: none;
    outline: none;
  }
  .fap-form-subscribe-field:has(> .fap-form-subscribe-field__input-email:focus),
  .fap-form-subscribe-field:hover {
    border: 2px solid var(--color-primary);
  }
  .fap-form-subscribe-confirm {
    display: flex;
    align-items: center;
    position: relative;
    padding: 0 0 0 1.42em;
    flex-wrap: wrap;
  }
  .fap-form-subscribe-confirm__error-message {
      display: none;
      width: 100%;
      font-size: 90%;
      margin: .5rem 0 0;
      color: #ff0000;
    }
  .fap-form-subscribe-confirm label {
    position: relative;
    padding: 0 0 0 1em;
  }
  .fap-form-subscribe-confirm label::before {
    content: "";
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: -20px;
    width: 20px;
    height: 20px;
    background-image: url(https://static.wow2print.com/storage/245/content/image/90930578266719a65d9af03.93046006.svg);
    transition: var(--animate-default);
  }
  .fap-form-subscribe-confirm input {
    overflow: hidden;
    width: 0;
    height: 0;
  }
  
  .fap-form-subscribe-confirm:has(input[type="checkbox"]:checked) {
    position: relative;
  }

  .fap-form-subscribe-confirm input:checked + label::before {
    background-image: url(https://static.wow2print.com/storage/245/content/image/94275259066719a645797d2.27350813.svg);
  }
</style>

<script>
  const form = document.querySelector(`form[name='subscribtion_form']`);
  form.addEventListener("submit", (e) => {

    e.preventDefault();
    let formData = new FormData(form);
    console.log(formData.get("confirm"));

    if (formData.get("confirm")) {

      messageConfirm.style.display = "none";
      showStatus("pending");

      fetch(`${e.target.action}`, {
          method: form.method,
          body: formData 
      })
      .then(response => {
          if(response.ok) {
            console.log(`Code status: ${response.status}`);
            console.log(`Status text: ${response.statusText}`);
            showStatus("success");
          }

      })
      .catch(error => {
          console.log(error);
          showStatus("error");
          successStatus.querySelector('span').innerHTML == `Ошибка ${error.status}: ${error.statusText}.<br />Попробуйте повторить попытку.`
      })
    }
    else {
      messageConfirm.style.display = "block";
    }
  });

  const pendingStatus = document.querySelector(`.fap-form-subscribe__status--pending`);
  const errorStatus = document.querySelector(`.fap-form-subscribe__status--error`);
  const successStatus = document.querySelector(`.fap-form-subscribe__status--success`);
  const emailInput = document.querySelector(`.fap-form-subscribe-field`);
  const messageConfirm = document.querySelector(`.fap-form-subscribe-confirm__error-message`);

  const showStatus = (status) => {
    if (status == "pending") {
      pendingStatus.removeAttribute("hidden");
      successStatus.setAttribute("hidden", "");
      errorStatus.setAttribute("hidden", "");
      emailInput.style.display = "none";
    }
    if (status == "success") {
      pendingStatus.setAttribute("hidden", "");
      successStatus.removeAttribute("hidden");
      errorStatus.setAttribute("hidden", "");
      emailInput.style.display = "none";
    }
    if (status == "error") {
      pendingStatus.setAttribute("hidden", "");
      successStatus.setAttribute("hidden", "");
      errorStatus.removeAttribute("hidden");
      emailInput.style.display = "flex";
    }
  }




</script>
